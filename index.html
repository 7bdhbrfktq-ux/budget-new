<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Budget Tracker">
    <meta name="theme-color" content="#667eea">
    <title>Budget Tracker Pro</title>
    <link rel="manifest" href="/budget-new/manifest.json">
    <link rel="apple-touch-icon" href="/budget-new/icon-192.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --card-bg: white;
            --text-primary: #333;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --input-bg: white;
            --shadow: rgba(0, 0, 0, 0.15);
            --header-text: white;
        }

        body.dark-mode {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --card-bg: #2d2d44;
            --text-primary: #e5e5e5;
            --text-secondary: #a0a0b0;
            --text-muted: #6b6b7b;
            --border-color: #3d3d54;
            --input-bg: #1e1e2f;
            --shadow: rgba(0, 0, 0, 0.4);
            --header-text: #e5e5e5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
            overflow-x: hidden;
            transition: background 0.3s ease;
        }

        .container {
            max-width: 100%;
            padding: 0;
        }

        header {
            text-align: center;
            color: white;
            padding: 20px 20px 15px 20px;
            padding-top: max(20px, env(safe-area-inset-top));
        }

        h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .tagline {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            padding: 0 15px;
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            padding: 0 15px;
            margin-bottom: 20px;
        }

        .stat-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 18px 15px;
            box-shadow: 0 4px 12px var(--shadow);
            transition: background 0.3s ease;
        }

        .card.small {
            padding: 15px 12px;
        }

        .card h2 {
            font-size: 0.75em;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            line-height: 1.2;
        }

        .stat-value.income {
            color: #10b981;
        }

        .stat-value.expenses {
            color: #ef4444;
        }

        .stat-value.balance {
            color: #667eea;
        }

        .balance-text {
            margin-top: 5px;
            color: var(--text-secondary);
            font-size: 0.75em;
        }

        .chart-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px 15px;
            margin: 0 15px 15px 15px;
            box-shadow: 0 4px 12px var(--shadow);
            transition: background 0.3s ease;
        }

        .chart-container h2 {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        canvas {
            max-height: 250px;
        }

        .quick-add {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px 15px;
            margin: 0 15px 15px 15px;
            box-shadow: 0 4px 12px var(--shadow);
            transition: background 0.3s ease;
        }

        .quick-add h2 {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
            background: #f3f4f6;
            padding: 4px;
            border-radius: 12px;
        }

        .tab {
            padding: 10px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.2s;
            color: #6b7280;
        }

        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
            font-size: 0.9em;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.2s;
            background: var(--input-bg);
            color: var(--text-primary);
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="date"] {
            padding: 10px 12px;
            line-height: 1.5;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .section {
            background: var(--card-bg);
            border-radius: 16px 16px 0 0;
            padding: 20px 15px;
            margin-top: 15px;
            min-height: 200px;
            transition: background 0.3s ease;
        }

        .section h2 {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .goal-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 20px;
            color: white;
            margin-bottom: 15px;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .goal-title {
            font-size: 1.1em;
            font-weight: 700;
        }

        .goal-amount {
            font-size: 1.3em;
            font-weight: 700;
        }

        .goal-progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .goal-progress-fill {
            height: 100%;
            background: white;
            border-radius: 6px;
            transition: width 0.3s;
        }

        .goal-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            opacity: 0.95;
        }

        .insight-card {
            background: #f9fafb;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .insight-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        .insight-text {
            color: #6b7280;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .insight-card.warning {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .insight-card.success {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .transaction-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .transaction-icon.income {
            background: #d1fae5;
        }

        .transaction-icon.expense {
            background: #fee2e2;
        }

        .transaction-info {
            flex: 1;
            min-width: 0;
        }

        .transaction-desc {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 3px;
            font-size: 0.95em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .transaction-meta {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        .transaction-amount {
            font-weight: 700;
            font-size: 1em;
            white-space: nowrap;
            margin-left: 10px;
        }

        .transaction-amount.income {
            color: #10b981;
        }

        .transaction-amount.expense {
            color: #ef4444;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .category-item:last-child {
            border-bottom: none;
        }

        .category-info {
            flex: 1;
        }

        .category-name {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .category-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .category-bar-fill {
            height: 100%;
            background: #667eea;
            border-radius: 3px;
        }

        .category-amount {
            font-weight: 700;
            color: #667eea;
            font-size: 0.95em;
            margin-left: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            border-radius: 3px;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
        }

        .month-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            margin-bottom: 15px;
        }

        .month-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
        }

        .month-display {
            color: white;
            font-weight: 700;
            font-size: 1.1em;
        }

        .install-prompt {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin: 0 15px 15px 15px;
            box-shadow: 0 4px 12px var(--shadow);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.3s ease;
        }

        .install-prompt.hidden {
            display: none;
        }

        .install-icon {
            font-size: 2em;
        }

        .install-content {
            flex: 1;
        }

        .install-title {
            font-weight: 600;
            margin-bottom: 3px;
            color: var(--text-primary);
        }

        .install-text {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .install-close {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            transition: background 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #9ca3af;
        }

        .dark-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 20px var(--shadow);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            z-index: 9999;
            transition: transform 0.2s, background 0.3s ease;
        }

        .dark-mode-toggle:active {
            transform: scale(0.95);
        }

        .dark-mode-toggle:hover {
            transform: scale(1.05);
        }

        @supports (backdrop-filter: blur(10px)) {
            .card, .quick-add, .section, .install-prompt {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
            }
            
            body.dark-mode .card, 
            body.dark-mode .quick-add, 
            body.dark-mode .section, 
            body.dark-mode .install-prompt,
            body.dark-mode .modal-content,
            body.dark-mode .dark-mode-toggle {
                background: rgba(45, 45, 68, 0.95);
                backdrop-filter: blur(10px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üí∞ Budget Tracker Pro</h1>
            <p class="tagline">Smart financial management</p>
        </header>

        <div class="month-selector">
            <button class="month-btn" onclick="changeMonth(-1)">‚Äπ</button>
            <div class="month-display" id="currentMonth"></div>
            <button class="month-btn" onclick="changeMonth(1)">‚Ä∫</button>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchPage('overview')">Overview</button>
            <button class="nav-tab" onclick="switchPage('analytics')">Analytics</button>
            <button class="nav-tab" onclick="switchPage('goals')">Goals</button>
            <button class="nav-tab" onclick="switchPage('insights')">Insights</button>
        </div>

        <div id="installPrompt" class="install-prompt hidden">
            <div class="install-icon">üì±</div>
            <div class="install-content">
                <div class="install-title">Install App</div>
                <div class="install-text">Add to Home Screen for quick access</div>
            </div>
            <button class="install-close" onclick="closeInstallPrompt()">√ó</button>
        </div>

        <!-- OVERVIEW PAGE -->
        <div id="overviewPage" class="page active">
            <div class="dashboard">
                <div class="stat-cards">
                    <div class="card small">
                        <h2>Income</h2>
                        <div class="stat-value income" id="totalIncome">$0</div>
                    </div>

                    <div class="card small">
                        <h2>Expenses</h2>
                        <div class="stat-value expenses" id="totalExpenses">$0</div>
                    </div>

                    <div class="card small">
                        <h2>Balance</h2>
                        <div class="stat-value balance" id="balance">$0</div>
                    </div>
                </div>

                <div class="card">
                    <h2>This Month</h2>
                    <div class="balance-text" id="balanceText">Start tracking your finances</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="expenseProgress" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <div class="quick-add">
                <h2>Quick Add</h2>
                <div class="tabs">
                    <button class="tab active" id="incomeTab" onclick="setTransactionType('income')">Income</button>
                    <button class="tab" id="expenseTab" onclick="setTransactionType('expense')">Expense</button>
                </div>
                <form id="transactionForm">
                    <div class="form-group">
                        <label for="description">Description</label>
                        <input type="text" id="description" placeholder="What's this for?" required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount</label>
                        <input type="number" id="amount" placeholder="0.00" step="0.01" min="0" required inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category" required>
                            <option value="">Choose category</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date" required>
                    </div>
                    <button type="submit" class="btn-primary">Add Transaction</button>
                </form>
            </div>

            <div class="section">
                <h2>üìù Recent Transactions</h2>
                <div id="transactionList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∏</div>
                        <div>No transactions yet</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">Add your first transaction above</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ANALYTICS PAGE -->
        <div id="analyticsPage" class="page">
            <div class="chart-container">
                <h2>üìä Spending Breakdown</h2>
                <canvas id="categoryChart"></canvas>
            </div>

            <div class="chart-container">
                <h2>üìà Income vs Expenses</h2>
                <canvas id="trendChart"></canvas>
            </div>

            <div class="section">
                <h2>üìä Category Details</h2>
                <div id="categoryBreakdown">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div>No expenses yet</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GOALS PAGE -->
        <div id="goalsPage" class="page">
            <div style="padding: 0 15px; margin-bottom: 15px;">
                <button class="btn-primary" onclick="openGoalModal()">+ New Savings Goal</button>
            </div>

            <div style="padding: 0 15px;" id="goalsList">
                <div class="empty-state">
                    <div class="empty-state-icon">üéØ</div>
                    <div>No savings goals yet</div>
                    <div style="font-size: 0.9em; margin-top: 5px;">Create your first goal above</div>
                </div>
            </div>
        </div>

        <!-- INSIGHTS PAGE -->
        <div id="insightsPage" class="page">
            <div class="section">
                <h2>üí° Smart Insights</h2>
                <div id="insightsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üí°</div>
                        <div>Not enough data for insights</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">Add more transactions to get personalized insights</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GOAL MODAL -->
        <div id="goalModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">New Savings Goal</h3>
                    <button class="modal-close" onclick="closeGoalModal()">√ó</button>
                </div>
                <form id="goalForm">
                    <div class="form-group">
                        <label for="goalName">Goal Name</label>
                        <input type="text" id="goalName" placeholder="e.g., Emergency Fund" required>
                    </div>
                    <div class="form-group">
                        <label for="goalTarget">Target Amount</label>
                        <input type="number" id="goalTarget" placeholder="0.00" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="goalCurrent">Current Amount</label>
                        <input type="number" id="goalCurrent" placeholder="0.00" step="0.01" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="goalDeadline">Target Date (Optional)</label>
                        <input type="date" id="goalDeadline">
                    </div>
                    <button type="submit" class="btn-primary">Create Goal</button>
                </form>
            </div>
        </div>

        <!-- Dark Mode Toggle -->
        <button class="dark-mode-toggle" onclick="toggleDarkMode()" id="darkModeToggle" title="Toggle Dark Mode">
            üåô
        </button>
    </div>

    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/budget-new/sw.js').then(registration => {
                console.log('Service Worker registered');
            }).catch(error => {
                console.log('Service Worker registration failed:', error);
            });
        }

        // Install Prompt
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPrompt.classList.remove('hidden');
        });

        installPrompt.addEventListener('click', async (e) => {
            if (e.target.closest('.install-close')) return;
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
            installPrompt.classList.add('hidden');
        });

        function closeInstallPrompt() {
            installPrompt.classList.add('hidden');
        }

        // Dark Mode Toggle
        function toggleDarkMode() {
            const body = document.body;
            const toggle = document.getElementById('darkModeToggle');
            
            body.classList.toggle('dark-mode');
            
            // Update icon
            if (body.classList.contains('dark-mode')) {
                toggle.textContent = '‚òÄÔ∏è';
                localStorage.setItem('darkMode', 'enabled');
            } else {
                toggle.textContent = 'üåô';
                localStorage.setItem('darkMode', 'disabled');
            }
            
            // Update charts if on analytics page
            if (document.getElementById('analyticsPage').classList.contains('active')) {
                setTimeout(() => updateCharts(), 100);
            }
        }

        // Load dark mode preference
        function loadDarkModePreference() {
            const darkMode = localStorage.getItem('darkMode');
            const toggle = document.getElementById('darkModeToggle');
            
            if (darkMode === 'enabled') {
                document.body.classList.add('dark-mode');
                toggle.textContent = '‚òÄÔ∏è';
            } else if (darkMode === null) {
                // Check system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-mode');
                    toggle.textContent = '‚òÄÔ∏è';
                    localStorage.setItem('darkMode', 'enabled');
                }
            }
        }

        // App State
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let goals = JSON.parse(localStorage.getItem('goals')) || [];
        let transactionType = 'income';
        let currentDate = new Date();
        let charts = {};

        const incomeCategories = ['Salary', 'Freelance', 'Investment', 'Gift', 'Other Income'];
        const expenseCategories = ['Housing', 'Food & Dining', 'Transportation', 'Utilities', 'Healthcare', 'Entertainment', 'Shopping', 'Education', 'Insurance', 'Debt Payment', 'Savings', 'Other'];

        const categoryIcons = {
            'Salary': 'üíº', 'Freelance': 'üíª', 'Investment': 'üìà', 'Gift': 'üéÅ', 'Other Income': 'üíµ',
            'Housing': 'üè†', 'Food & Dining': 'üçΩÔ∏è', 'Transportation': 'üöó', 'Utilities': 'üí°',
            'Healthcare': 'üè•', 'Entertainment': 'üé¨', 'Shopping': 'üõçÔ∏è', 'Education': 'üìö',
            'Insurance': 'üõ°Ô∏è', 'Debt Payment': 'üí≥', 'Savings': 'üè¶', 'Other': 'üìå'
        };

        // Navigation
        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(`${page}Page`).classList.add('active');
            event.target.classList.add('active');

            if (page === 'analytics') {
                setTimeout(() => {
                    updateCharts();
                }, 100);
            } else if (page === 'insights') {
                updateInsights();
            }
        }

        // Month Navigation
        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            updateMonthDisplay();
            updateAll();
        }

        function updateMonthDisplay() {
            const options = { month: 'long', year: 'numeric' };
            document.getElementById('currentMonth').textContent = currentDate.toLocaleDateString('en-US', options);
        }

        function getMonthTransactions() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            return transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate.getFullYear() === year && tDate.getMonth() === month;
            });
        }

        // Transaction Management
        function setTransactionType(type) {
            transactionType = type;
            document.getElementById('incomeTab').classList.toggle('active', type === 'income');
            document.getElementById('expenseTab').classList.toggle('active', type === 'expense');
            updateCategoryOptions();
        }

        function updateCategoryOptions() {
            const categorySelect = document.getElementById('category');
            const categories = transactionType === 'income' ? incomeCategories : expenseCategories;
            
            categorySelect.innerHTML = '<option value="">Choose category</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        function formatCurrency(amount) {
            if (amount >= 1000) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
            }
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function calculateTotals() {
            const monthTransactions = getMonthTransactions();
            
            const income = monthTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expenses = monthTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const balance = income - expenses;

            document.getElementById('totalIncome').textContent = formatCurrency(income);
            document.getElementById('totalExpenses').textContent = formatCurrency(expenses);
            document.getElementById('balance').textContent = formatCurrency(balance);

            const expensePercentage = income > 0 ? (expenses / income) * 100 : 0;
            document.getElementById('expenseProgress').style.width = Math.min(expensePercentage, 100) + '%';

            const balanceText = document.getElementById('balanceText');
            if (income === 0 && expenses === 0) {
                balanceText.textContent = 'Start tracking your finances';
            } else if (balance > 0) {
                balanceText.textContent = `${Math.round(100 - expensePercentage)}% of income remaining üéâ`;
            } else if (balance < 0) {
                balanceText.textContent = 'Spending more than earning ‚ö†Ô∏è';
            } else {
                balanceText.textContent = 'Breaking even';
            }
        }

        function updateCategoryBreakdown() {
            const monthTransactions = getMonthTransactions();
            const expensesByCategory = {};
            const totalExpenses = monthTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            monthTransactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
                });

            const breakdownDiv = document.getElementById('categoryBreakdown');
            
            if (Object.keys(expensesByCategory).length === 0) {
                breakdownDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div>No expenses yet</div>
                    </div>
                `;
                return;
            }

            const sortedCategories = Object.entries(expensesByCategory)
                .sort((a, b) => b[1] - a[1]);

            breakdownDiv.innerHTML = sortedCategories
                .map(([category, amount]) => {
                    const percentage = (amount / totalExpenses) * 100;
                    return `
                        <div class="category-item">
                            <div class="category-info">
                                <div class="category-name">${categoryIcons[category] || 'üìå'} ${category}</div>
                                <div class="category-bar">
                                    <div class="category-bar-fill" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                            <div class="category-amount">${formatCurrency(amount)}</div>
                        </div>
                    `;
                }).join('');
        }

        function renderTransactions() {
            const listDiv = document.getElementById('transactionList');
            const monthTransactions = getMonthTransactions();
            
            if (monthTransactions.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∏</div>
                        <div>No transactions this month</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">Add your first transaction above</div>
                    </div>
                `;
                return;
            }

            const sortedTransactions = [...monthTransactions]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 20);

            listDiv.innerHTML = sortedTransactions.map((t) => `
                <div class="transaction-item">
                    <div class="transaction-icon ${t.type}">
                        ${categoryIcons[t.category] || (t.type === 'income' ? 'üíµ' : 'üí∏')}
                    </div>
                    <div class="transaction-info">
                        <div class="transaction-desc">${t.description}</div>
                        <div class="transaction-meta">${t.category} ‚Ä¢ ${new Date(t.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                    </div>
                    <div class="transaction-amount ${t.type}">
                        ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                    </div>
                    <button class="delete-btn" onclick="deleteTransaction(${t.id})">√ó</button>
                </div>
            `).join('');
        }

        function deleteTransaction(id) {
            if (confirm('Delete this transaction?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveAndUpdate();
            }
        }

        // Charts
        function updateCharts() {
            updateCategoryChart();
            updateTrendChart();
        }

        function getChartColors() {
            const isDark = document.body.classList.contains('dark-mode');
            return {
                textColor: isDark ? '#e5e5e5' : '#333',
                gridColor: isDark ? '#3d3d54' : '#e5e7eb'
            };
        }

        function updateCategoryChart() {
            const monthTransactions = getMonthTransactions();
            const expensesByCategory = {};
            
            monthTransactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
                });

            const ctx = document.getElementById('categoryChart');
            
            if (charts.category) {
                charts.category.destroy();
            }

            if (Object.keys(expensesByCategory).length === 0) {
                return;
            }

            const sortedData = Object.entries(expensesByCategory).sort((a, b) => b[1] - a[1]);
            const colors = getChartColors();
            
            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedData.map(([cat]) => cat),
                    datasets: [{
                        data: sortedData.map(([, amt]) => amt),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0',
                            '#a8edea', '#fed6e3'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 11 },
                                color: colors.textColor
                            }
                        }
                    }
                }
            });
        }

        function updateTrendChart() {
            const last6Months = [];
            const tempDate = new Date(currentDate);
            
            for (let i = 5; i >= 0; i--) {
                const d = new Date(tempDate);
                d.setMonth(d.getMonth() - i);
                last6Months.push(d);
            }

            const incomeData = [];
            const expenseData = [];
            const labels = [];

            last6Months.forEach(date => {
                const year = date.getFullYear();
                const month = date.getMonth();
                
                const monthTrans = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getFullYear() === year && tDate.getMonth() === month;
                });

                const income = monthTrans
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const expenses = monthTrans
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);

                incomeData.push(income);
                expenseData.push(expenses);
                labels.push(date.toLocaleDateString('en-US', { month: 'short' }));
            });

            const ctx = document.getElementById('trendChart');
            
            if (charts.trend) {
                charts.trend.destroy();
            }

            const colors = getChartColors();

            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Income',
                        data: incomeData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Expenses',
                        data: expenseData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 11 },
                                color: colors.textColor
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                },
                                color: colors.textColor
                            },
                            grid: {
                                color: colors.gridColor
                            }
                        },
                        x: {
                            ticks: {
                                color: colors.textColor
                            },
                            grid: {
                                color: colors.gridColor
                            }
                        }
                    }
                }
            });
        }

        // Goals
        function openGoalModal() {
            document.getElementById('goalModal').classList.add('active');
        }

        function closeGoalModal() {
            document.getElementById('goalModal').classList.remove('active');
            document.getElementById('goalForm').reset();
        }

        function renderGoals() {
            const listDiv = document.getElementById('goalsList');
            
            if (goals.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéØ</div>
                        <div>No savings goals yet</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">Create your first goal above</div>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = goals.map(goal => {
                const progress = (goal.current / goal.target) * 100;
                const remaining = goal.target - goal.current;
                let deadlineText = '';
                
                if (goal.deadline) {
                    const daysLeft = Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                    deadlineText = daysLeft > 0 ? `${daysLeft} days left` : 'Past deadline';
                }

                return `
                    <div class="goal-card">
                        <div class="goal-header">
                            <div class="goal-title">üéØ ${goal.name}</div>
                            <button class="delete-btn" onclick="deleteGoal(${goal.id})">√ó</button>
                        </div>
                        <div class="goal-amount">${formatCurrency(goal.current)} / ${formatCurrency(goal.target)}</div>
                        <div class="goal-progress-bar">
                            <div class="goal-progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
                        </div>
                        <div class="goal-stats">
                            <span>${Math.round(progress)}% Complete</span>
                            <span>${remaining > 0 ? formatCurrency(remaining) + ' to go' : 'Goal reached! üéâ'}</span>
                        </div>
                        ${deadlineText ? `<div style="margin-top: 10px; font-size: 0.9em;">‚è∞ ${deadlineText}</div>` : ''}
                        ${progress < 100 ? `
                            <button class="btn-primary" style="margin-top: 15px; padding: 10px;" onclick="addToGoal(${goal.id})">
                                Add Money
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function addToGoal(id) {
            const amount = prompt('How much would you like to add?');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const goal = goals.find(g => g.id === id);
                if (goal) {
                    goal.current += parseFloat(amount);
                    localStorage.setItem('goals', JSON.stringify(goals));
                    renderGoals();
                }
            }
        }

        function deleteGoal(id) {
            if (confirm('Delete this goal?')) {
                goals = goals.filter(g => g.id !== id);
                localStorage.setItem('goals', JSON.stringify(goals));
                renderGoals();
            }
        }

        // Insights
        function updateInsights() {
            const listDiv = document.getElementById('insightsList');
            const monthTransactions = getMonthTransactions();
            const insights = [];

            if (monthTransactions.length < 5) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí°</div>
                        <div>Not enough data for insights</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">Add more transactions to get personalized insights</div>
                    </div>
                `;
                return;
            }

            // Calculate insights
            const income = monthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const savingsRate = income > 0 ? ((income - expenses) / income) * 100 : 0;

            // Savings Rate Insight
            if (savingsRate > 20) {
                insights.push({
                    type: 'success',
                    title: 'üéâ Excellent Savings Rate!',
                    text: `You're saving ${Math.round(savingsRate)}% of your income. Keep up the great work!`
                });
            } else if (savingsRate > 0) {
                insights.push({
                    type: 'warning',
                    title: 'üí° Savings Opportunity',
                    text: `You're saving ${Math.round(savingsRate)}% of income. Try to reach 20% for better financial health.`
                });
            } else {
                insights.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è Spending Alert',
                    text: `You're spending more than you earn this month. Review your expenses to find areas to cut back.`
                });
            }

            // Top spending category
            const expensesByCategory = {};
            monthTransactions.filter(t => t.type === 'expense').forEach(t => {
                expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
            });

            if (Object.keys(expensesByCategory).length > 0) {
                const topCategory = Object.entries(expensesByCategory).sort((a, b) => b[1] - a[1])[0];
                const percentage = (topCategory[1] / expenses) * 100;
                
                insights.push({
                    type: 'info',
                    title: 'üìä Top Spending Category',
                    text: `${topCategory[0]} accounts for ${Math.round(percentage)}% of your expenses (${formatCurrency(topCategory[1])}).`
                });
            }

            // Compare to last month
            const lastMonth = new Date(currentDate);
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const lastMonthTrans = transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate.getFullYear() === lastMonth.getFullYear() && tDate.getMonth() === lastMonth.getMonth();
            });
            
            const lastMonthExpenses = lastMonthTrans.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            if (lastMonthExpenses > 0) {
                const change = ((expenses - lastMonthExpenses) / lastMonthExpenses) * 100;
                if (Math.abs(change) > 10) {
                    insights.push({
                        type: change > 0 ? 'warning' : 'success',
                        title: change > 0 ? 'üìà Spending Increased' : 'üìâ Spending Decreased',
                        text: `Your expenses ${change > 0 ? 'increased' : 'decreased'} by ${Math.abs(Math.round(change))}% compared to last month.`
                    });
                }
            }

            // Goal progress
            if (goals.length > 0) {
                const goalsNearCompletion = goals.filter(g => {
                    const progress = (g.current / g.target) * 100;
                    return progress >= 80 && progress < 100;
                });
                
                if (goalsNearCompletion.length > 0) {
                    insights.push({
                        type: 'success',
                        title: 'üéØ Almost There!',
                        text: `You're close to completing ${goalsNearCompletion.length} savings goal${goalsNearCompletion.length > 1 ? 's' : ''}!`
                    });
                }
            }

            listDiv.innerHTML = insights.map(insight => `
                <div class="insight-card ${insight.type}">
                    <div class="insight-title">${insight.title}</div>
                    <div class="insight-text">${insight.text}</div>
                </div>
            `).join('');
        }

        // Save and Update
        function saveAndUpdate() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            updateAll();
        }

        function updateAll() {
            calculateTotals();
            renderTransactions();
            updateCategoryBreakdown();
            renderGoals();
        }

        // Form Handlers
        document.getElementById('transactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const transaction = {
                id: Date.now(),
                type: transactionType,
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                date: document.getElementById('date').value
            };

            transactions.push(transaction);
            saveAndUpdate();

            this.reset();
            setDefaultDate();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        document.getElementById('goalForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const goal = {
                id: Date.now(),
                name: document.getElementById('goalName').value,
                target: parseFloat(document.getElementById('goalTarget').value),
                current: parseFloat(document.getElementById('goalCurrent').value) || 0,
                deadline: document.getElementById('goalDeadline').value || null
            };

            goals.push(goal);
            localStorage.setItem('goals', JSON.stringify(goals));
            renderGoals();
            closeGoalModal();
        });

        // Initialize
        loadDarkModePreference();
        updateCategoryOptions();
        setDefaultDate();
        updateMonthDisplay();
        updateAll();
    </script>
</body>
</html>
